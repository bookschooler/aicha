"""
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
26_add_subway_lines.py — 상권별 지하철 노선 수 추가
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
목적:
  기존 지하철_역_수(반경 500m 내 역 개수) 변수에 더해
  지하철_노선_수(반경 500m 내 통과하는 노선 수 합산) 변수 추가

계산 방법:
  각 역마다 노선 수를 딕셔너리로 미리 정의
  → KDTree로 각 상권 반경 500m 내 역들을 찾음
  → 해당 역들의 노선_수를 합산 → 지하철_노선_수

입력: station_coords.csv, to_map.csv, y_demand_supply_trend_merge.csv
출력: y_demand_supply_trend_merge.csv (지하철_노선_수 컬럼 추가, 덮어쓰기)
"""

import os                           # 작업 디렉토리 변경 (17번에서 상세 설명)
import pandas as pd                 # 데이터프레임 라이브러리 (17번에서 상세 설명)
import numpy as np                  # 수치 계산 (17번에서 상세 설명)
from scipy.spatial import cKDTree   # 최근접 탐색 KD트리 (17번에서 상세 설명)
import pyproj                       # 좌표계 변환 라이브러리 (17번에서 상세 설명)
#  └ [pyproj 라이브러리]
#    · 17번에서 from pyproj import Transformer 로 특정 클래스만 임포트했음
#    · 여기서는 import pyproj 로 전체 임포트 후 pyproj.Transformer 로 접근
#    · 두 방식 모두 동일하게 동작 (취향/스타일 차이)

os.chdir('/teamspace/studios/this_studio/aicha')


# ══════════════════════════════════════════════════════
# 역명 → 노선 수 딕셔너리 (수동 정의)
# ══════════════════════════════════════════════════════
# 219개 서울 지하철역 각각의 환승 가능 노선 수를 딕셔너리로 정의
# (서울 지하철 노선도 기반 수동 입력)
STATION_LINES = {
    '4.19민주묘지역': 2,  # 6호선, 우이신설선
    '가락시장역':     3,  # 3, 5, 8호선
    '가양역':         1,  # 9호선
    '가오리역':       2,  # 6호선, 우이신설선
    '가좌역':         1,  # 경의중앙선
    '강남구청역':     1,  # 7호선
    '강남역':         2,  # 2호선, 신분당선
    '강동구청역':     1,  # 8호선
    '개롱역':         1,  # 5호선
    '개봉역':         1,  # 1호선
    '개화산역':       1,  # 5호선
    '거여역':         1,  # 5호선
    '건대입구역':     2,  # 2, 7호선
    '경의중앙 신촌역': 1, # 경의중앙선
    '경찰병원역':     1,  # 3호선
    '고덕역':         1,  # 5호선
    '고려대역':       2,  # 6호선, 우이신설선
    '공릉역':         1,  # 7호선
    '공항시장역':     1,  # 9호선
    '광나루역':       1,  # 5호선
    '광운대역':       2,  # 1호선, 경춘선
    '광화문역':       1,  # 5호선
    '광흥창역':       1,  # 6호선
    '구로디지털단지역': 1, # 2호선
    '구로역':         2,  # 1, 7호선
    '구반포역':       1,  # 9호선
    '구산역':         1,  # 6호선
    '구의역':         1,  # 2호선
    '구파발역':       1,  # 3호선
    '군자역':         2,  # 5, 7호선
    '굽은다리역':     1,  # 5호선
    '금호역':         1,  # 3호선
    '길동역':         1,  # 5호선
    '길음역':         1,  # 4호선
    '까치산역':       2,  # 2, 5호선
    '남구로역':       1,  # 7호선
    '남부터미널역':   1,  # 3호선
    '남성역':         1,  # 7호선
    '남영역':         1,  # 1호선
    '내방역':         1,  # 7호선
    '노량진역':       2,  # 1, 9호선
    '노원역':         2,  # 4, 7호선
    '논현역':         1,  # 7호선
    '답십리역':       1,  # 5호선
    '당고개역':       1,  # 4호선
    '당산역':         2,  # 2, 9호선
    '대림역':         2,  # 2, 7호선
    '대방역':         1,  # 1호선
    '대치역':         1,  # 3호선
    '대흥역':         1,  # 6호선
    '도봉산역':       2,  # 1, 7호선
    '도봉역':         1,  # 1호선
    '독립문역':       1,  # 3호선
    '돌곶이역':       1,  # 6호선
    '동대문역':       2,  # 1, 4호선
    '동대문역사문화공원역': 3, # 2, 4, 5호선
    '동묘앞역':       2,  # 1, 6호선
    '둔촌동역':       1,  # 5호선
    '둔촌역':         1,  # 9호선 (둔촌오륜)
    '등촌역':         1,  # 9호선
    '뚝섬역':         1,  # 2호선
    '뚝섬유원지역':   1,  # 7호선
    '마들역':         1,  # 7호선
    '마장역':         1,  # 5호선
    '마포구청역':     1,  # 6호선
    '마포역':         1,  # 5호선
    '망우역':         2,  # 경의중앙선, 경춘선
    '망원역':         1,  # 6호선
    '매봉역':         1,  # 3호선
    '먹골역':         1,  # 7호선
    '면목역':         1,  # 7호선
    '명일역':         1,  # 5호선
    '목동역':         1,  # 5호선
    '몽촌토성역':     1,  # 8호선
    '문래역':         1,  # 2호선
    '문정역':         2,  # 5, 8호선
    '미아사거리역':   1,  # 4호선
    '미아역':         1,  # 4호선
    '발산역':         1,  # 5호선
    '방배역':         1,  # 2호선
    '방이역':         1,  # 5호선
    '방학역':         1,  # 1호선
    '방화역':         1,  # 5호선
    '보라매역':       1,  # 7호선
    '보문역':         2,  # 6호선, 우이신설선
    '봉은사역':       1,  # 9호선
    '봉천역':         1,  # 2호선
    '북한산보국문역': 1,  # 우이신설선
    '북한산우이역':   1,  # 우이신설선
    '불광역':         2,  # 3, 6호선
    '사가정역':       1,  # 7호선
    '사당역':         2,  # 2, 4호선
    '삼각지역':       2,  # 4, 6호선
    '삼성역':         1,  # 2호선
    '삼성중앙역':     1,  # 9호선
    '삼양사거리역':   2,  # 6호선, 우이신설선
    '삼전역':         1,  # 9호선
    '상계역':         1,  # 4호선
    '상도역':         1,  # 7호선
    '상봉역':         3,  # 7호선, 경의중앙선, 경춘선
    '상수역':         1,  # 6호선
    '상왕십리역':     1,  # 2호선
    '상월곡역':       1,  # 6호선
    '새절역':         1,  # 6호선
    '서강대역':       1,  # 경의중앙선
    '서대문역':       1,  # 5호선
    '서빙고역':       1,  # 경의중앙선
    '서울대입구역':   1,  # 2호선
    '서울숲역':       1,  # 수인분당선
    '서울역':         4,  # 1, 4호선, 경의중앙선, 공항철도
    '서초역':         1,  # 2호선
    '석계역':         2,  # 1, 6호선
    '석촌고분역':     1,  # 9호선
    '석촌역':         2,  # 8, 9호선
    '선릉역':         2,  # 2호선, 수인분당선
    '선유도역':       1,  # 9호선
    '선정릉역':       1,  # 9호선
    '성수역':         1,  # 2호선
    '성신여대입구역': 2,  # 4호선, 우이신설선
    '솔밭공원역':     1,  # 우이신설선
    '송정역':         1,  # 경의중앙선
    '송파나루역':     1,  # 9호선
    '송파역':         1,  # 8호선
    '수락산역':       1,  # 7호선
    '수색역':         1,  # 경의중앙선
    '수서역':         2,  # 3호선, 수인분당선
    '수유역':         1,  # 4호선
    '숙대입구역':     1,  # 4호선
    '숭실대입구역':   1,  # 7호선
    '신금호역':       1,  # 5호선
    '신길역':         1,  # 5호선
    '신내역':         1,  # 경의중앙선
    '신논현역':       1,  # 9호선
    '신당역':         2,  # 2, 6호선
    '신대방삼거리역': 1,  # 7호선
    '신대방역':       1,  # 2호선
    '신도림역':       2,  # 1, 2호선
    '신림역':         1,  # 2호선
    '신목동역':       1,  # 9호선
    '신방화역':       1,  # 9호선
    '신사역':         2,  # 3호선, 신분당선
    '신설동역':       3,  # 1, 2호선, 우이신설선
    '신정네거리역':   1,  # 2호선
    '신정역':         1,  # 5호선
    '신촌역':         1,  # 2호선 (경의중앙 신촌역과 별개)
    '신풍역':         1,  # 7호선
    '아차산역':       1,  # 5호선
    '아현역':         1,  # 2호선
    '안암역':         1,  # 6호선
    '암사역':         1,  # 8호선
    '압구정역':       1,  # 3호선
    '애오개역':       1,  # 5호선
    '약수역':         2,  # 3, 6호선
    '양재역':         2,  # 3호선, 신분당선
    '양천향교역':     1,  # 9호선
    '양평역':         1,  # 5호선
    '어린이대공원역': 1,  # 7호선
    '언주역':         1,  # 9호선
    '역삼역':         1,  # 2호선
    '역촌역':         1,  # 6호선
    '연신내역':       2,  # 3, 6호선
    '염창역':         1,  # 9호선
    '영등포구청역':   2,  # 2, 5호선
    '영등포시장역':   1,  # 5호선
    '영등포역':       1,  # 1호선
    '오금역':         2,  # 3, 5호선
    '오류동역':       1,  # 1호선
    '오목교역':       1,  # 5호선
    '옥수역':         2,  # 3호선, 경의중앙선
    '온수역':         2,  # 1, 7호선
    '왕십리역':       4,  # 2, 5호선, 경의중앙선, 수인분당선
    '외대앞역':       1,  # 1호선
    '우장산역':       1,  # 5호선
    '월계역':         1,  # 1호선
    '월곡역':         1,  # 6호선
    '을지로3가역':    2,  # 2, 3호선
    '을지로4가역':    2,  # 2, 5호선
    '을지로입구역':   1,  # 2호선
    '응암역':         1,  # 6호선
    '이대역':         1,  # 2호선
    '이수역':         2,  # 4, 7호선 (총신대입구=이수)
    '잠실나루역':     1,  # 2호선
    '잠실역':         2,  # 2, 8호선
    '잠원역':         1,  # 3호선
    '장승배기역':     1,  # 7호선
    '정릉역':         1,  # 우이신설선
    '제기동역':       1,  # 1호선
    '종각역':         1,  # 1호선
    '종로3가역':      3,  # 1, 3, 5호선
    '종로5가역':      1,  # 1호선
    '중곡역':         1,  # 7호선
    '중랑역':         1,  # 경의중앙선
    '중화역':         1,  # 7호선
    '증산역':         1,  # 6호선
    '창동역':         2,  # 1, 4호선
    '창신역':         1,  # 6호선
    '천호역':         2,  # 5, 8호선
    '청구역':         2,  # 5, 6호선
    '청담역':         1,  # 7호선
    '충무로역':       2,  # 3, 4호선
    '충정로역':       2,  # 2, 5호선
    '태릉입구역':     2,  # 6, 7호선
    '학동역':         1,  # 7호선
    '한강진역':       1,  # 6호선
    '한성대입구역':   1,  # 4호선
    '한성백제역':     1,  # 9호선
    '한양대역':       1,  # 2호선
    '한티역':         1,  # 수인분당선
    '합정역':         2,  # 2, 6호선
    '행당역':         2,  # 5, 6호선
    '혜화역':         1,  # 4호선
    '홍대입구역':     3,  # 2호선, 경의중앙선, 공항철도
    '홍제역':         1,  # 3호선
    '화계역':         1,  # 우이신설선
    '화곡역':         1,  # 5호선
    '화랑대역':       1,  # 6호선
    '회기역':         2,  # 1호선, 경의중앙선
    '회현역':         1,  # 4호선
    '효창공원앞역':   2,  # 6호선, 경의중앙선
}


# ══════════════════════════════════════════════════════
# 역 데이터 로드 및 노선_수 할당
# ══════════════════════════════════════════════════════
stations = pd.read_csv('station_coords.csv', encoding='utf-8-sig')  # 219개 역 좌표 데이터 로드

stations['노선_수'] = stations['역명'].map(STATION_LINES)
#  └ Series.map(딕셔너리)
#    · 시리즈의 각 값을 딕셔너리의 키로 조회해 대응하는 값으로 변환
#    · STATION_LINES에 없는 역은 NaN으로 채워짐
#    · 예: '강남역' → 2, '홍대입구역' → 3
#    · dict.get() 과 유사하지만 pandas Series에 일괄 적용

# 매핑 안 된 역 확인 (딕셔너리에 빠진 역이 있는지)
unmatched = stations[stations['노선_수'].isna()]['역명'].tolist()
#  └ stations[조건]: 조건이 True인 행만 필터링 (Boolean Indexing)
#  └ .isna(): NaN 여부 확인 (noqa: 22번에서 상세 설명)
#  └ .tolist(): pandas Series → 파이썬 리스트 변환

if unmatched:
    print(f"⚠️  매핑 안 된 역 ({len(unmatched)}개): {unmatched}")
    stations['노선_수'] = stations['노선_수'].fillna(1)  # 매핑 없는 역은 기본값 1로 처리
    #  └ .fillna(1): NaN을 1로 채움 (최소 1개 노선으로 가정)

stations['노선_수'] = stations['노선_수'].astype(int)  # 실수(1.0) → 정수(1)로 변환
print(f"역 데이터: {len(stations)}개, 노선_수 합계: {stations['노선_수'].sum()}")


# ══════════════════════════════════════════════════════
# WGS84 → TM(EPSG:5181) 좌표 변환
# ══════════════════════════════════════════════════════
transformer = pyproj.Transformer.from_crs("EPSG:4326", "EPSG:5181", always_xy=True)
#  └ pyproj.Transformer.from_crs(): WGS84 → TM 변환기 생성 (17번에서 상세 설명)
#    · import pyproj 후 pyproj.Transformer.from_crs() 형태로 접근

stations['tm_x'], stations['tm_y'] = transformer.transform(
    stations['역_lon'].values, stations['역_lat'].values  # 역 WGS84 좌표 → TM 변환
)


# ══════════════════════════════════════════════════════
# 상권 좌표 로드
# ══════════════════════════════════════════════════════
to_map   = pd.read_csv('to_map.csv', encoding='utf-8-sig')  # 상권 좌표 데이터
sanggwon = to_map[['상권_코드', '엑스좌표_값', '와이좌표_값']].drop_duplicates('상권_코드')
#  └ df.drop_duplicates('컬럼'): 해당 컬럼 기준 중복 제거 (첫 번째 행 유지)
#    · 상권_코드별로 분기가 여러 개 있는 경우 중복 제거해 1:1로 만듦


# ══════════════════════════════════════════════════════
# KDTree: 각 상권 반경 500m 내 역들의 노선_수 합산
# ══════════════════════════════════════════════════════
station_coords = stations[['tm_x', 'tm_y']].values  # 역 TM좌표 배열
tree           = cKDTree(station_coords)              # 역 좌표로 KD트리 구축

results = []
for _, row in sanggwon.iterrows():  # 각 상권별로 순회
    indices = tree.query_ball_point([row['엑스좌표_값'], row['와이좌표_값']], r=500)
    #  └ tree.query_ball_point(점, r=반경)
    #    · 지정한 점 기준 반경 r 이내에 있는 모든 점의 인덱스 목록 반환
    #    · tree.query()와 차이: query는 가장 가까운 k개, query_ball_point는 반경 내 전부
    #    · r=500: TM좌표 단위(미터)이므로 500 = 500m 반경
    #    · 반환: [인덱스1, 인덱스2, ...] 형태 리스트

    노선수합 = int(stations.iloc[indices]['노선_수'].sum()) if indices else 0
    #  └ stations.iloc[indices]: 위치 기반 인덱싱으로 해당 행들 선택
    #    · .iloc[리스트]: 여러 행을 위치(정수)로 한 번에 선택
    #  └ .sum(): 선택된 역들의 노선_수 합산
    #  └ if indices else 0: 반경 내 역이 없으면 0

    results.append({'상권_코드': int(row['상권_코드']), '지하철_노선_수': 노선수합})

noson_df = pd.DataFrame(results)  # 상권별 노선수 결과 → DataFrame
print(f"\n상권별 지하철_노선_수 분포:")
print(noson_df['지하철_노선_수'].value_counts().sort_index())
#  └ .value_counts(): 각 값의 등장 횟수 (21번에서 상세 설명)
#  └ .sort_index(): 인덱스(= 노선_수 값) 기준 오름차순 정렬


# ══════════════════════════════════════════════════════
# 최종 데이터셋에 지하철_노선_수 병합
# ══════════════════════════════════════════════════════
main = pd.read_csv('y_demand_supply_trend_merge.csv', encoding='utf-8-sig')  # 최종 데이터셋 로드
main = main.merge(noson_df, on='상권_코드', how='left')  # 상권코드 기준으로 LEFT JOIN
#  └ 단면 데이터(noson_df) + 패널 데이터(main) LEFT JOIN
#    · 상권코드만 키 → 모든 분기에 동일한 노선_수 값 반복 적용

main['지하철_노선_수'] = main['지하철_노선_수'].fillna(0).astype(int)  # NaN→0, float→int

# 저장 (기존 최종 데이터셋에 덮어쓰기)
main.to_csv('y_demand_supply_trend_merge.csv', index=False, encoding='utf-8-sig')
print(f"\n✅ 완료: {main.shape}")
print(f"기존 지하철_역_수: {main['지하철_역_수'].sum():.0f}")
print(f"신규 지하철_노선_수: {main['지하철_노선_수'].sum():.0f}")
