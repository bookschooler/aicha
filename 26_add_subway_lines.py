"""
26_add_subway_lines.py
역명 → 노선 수 매핑 후 상권별 지하철_노선_수 계산
기존 지하철_역_수는 유지, 새 변수 지하철_노선_수 추가
"""
import os
import pandas as pd
import numpy as np
from scipy.spatial import cKDTree
import pyproj

os.chdir('/teamspace/studios/this_studio/aicha')

# ── 역명 → 노선 수 매핑 (station_coords.csv 219개 기준) ──────────────────
STATION_LINES = {
    '4.19민주묘지역': 2,  # 6, 우이신설
    '가락시장역':     3,  # 3, 5, 8
    '가양역':         1,  # 9
    '가오리역':       2,  # 6, 우이신설
    '가좌역':         1,  # 경의중앙
    '강남구청역':     1,  # 7
    '강남역':         2,  # 2, 신분당
    '강동구청역':     1,  # 8
    '개롱역':         1,  # 5
    '개봉역':         1,  # 1
    '개화산역':       1,  # 5
    '거여역':         1,  # 5
    '건대입구역':     2,  # 2, 7
    '경의중앙 신촌역': 1, # 경의중앙 (2호선 신촌역과 별개)
    '경찰병원역':     1,  # 3
    '고덕역':         1,  # 5
    '고려대역':       2,  # 6, 우이신설
    '공릉역':         1,  # 7
    '공항시장역':     1,  # 9
    '광나루역':       1,  # 5
    '광운대역':       2,  # 1, 경춘선
    '광화문역':       1,  # 5
    '광흥창역':       1,  # 6
    '구로디지털단지역': 1, # 2
    '구로역':         2,  # 1, 7
    '구반포역':       1,  # 9
    '구산역':         1,  # 6
    '구의역':         1,  # 2
    '구파발역':       1,  # 3
    '군자역':         2,  # 5, 7
    '굽은다리역':     1,  # 5
    '금호역':         1,  # 3
    '길동역':         1,  # 5
    '길음역':         1,  # 4
    '까치산역':       2,  # 2, 5
    '남구로역':       1,  # 7
    '남부터미널역':   1,  # 3
    '남성역':         1,  # 7
    '남영역':         1,  # 1
    '내방역':         1,  # 7
    '노량진역':       2,  # 1, 9
    '노원역':         2,  # 4, 7
    '논현역':         1,  # 7
    '답십리역':       1,  # 5
    '당고개역':       1,  # 4
    '당산역':         2,  # 2, 9
    '대림역':         2,  # 2, 7
    '대방역':         1,  # 1
    '대치역':         1,  # 3
    '대흥역':         1,  # 6
    '도봉산역':       2,  # 1, 7
    '도봉역':         1,  # 1
    '독립문역':       1,  # 3
    '돌곶이역':       1,  # 6
    '동대문역':       2,  # 1, 4
    '동대문역사문화공원역': 3, # 2, 4, 5
    '동묘앞역':       2,  # 1, 6
    '둔촌동역':       1,  # 5
    '둔촌역':         1,  # 9 (둔촌오륜)
    '등촌역':         1,  # 9
    '뚝섬역':         1,  # 2
    '뚝섬유원지역':   1,  # 7
    '마들역':         1,  # 7
    '마장역':         1,  # 5
    '마포구청역':     1,  # 6
    '마포역':         1,  # 5
    '망우역':         2,  # 경의중앙, 경춘선
    '망원역':         1,  # 6
    '매봉역':         1,  # 3
    '먹골역':         1,  # 7
    '면목역':         1,  # 7
    '명일역':         1,  # 5
    '목동역':         1,  # 5
    '몽촌토성역':     1,  # 8
    '문래역':         1,  # 2
    '문정역':         2,  # 5, 8
    '미아사거리역':   1,  # 4
    '미아역':         1,  # 4
    '발산역':         1,  # 5
    '방배역':         1,  # 2
    '방이역':         1,  # 5
    '방학역':         1,  # 1
    '방화역':         1,  # 5
    '보라매역':       1,  # 7
    '보문역':         2,  # 6, 우이신설
    '봉은사역':       1,  # 9
    '봉천역':         1,  # 2
    '북한산보국문역': 1,  # 우이신설
    '북한산우이역':   1,  # 우이신설
    '불광역':         2,  # 3, 6
    '사가정역':       1,  # 7
    '사당역':         2,  # 2, 4
    '삼각지역':       2,  # 4, 6
    '삼성역':         1,  # 2
    '삼성중앙역':     1,  # 9
    '삼양사거리역':   2,  # 6, 우이신설
    '삼전역':         1,  # 9
    '상계역':         1,  # 4
    '상도역':         1,  # 7
    '상봉역':         3,  # 7, 경의중앙, 경춘선
    '상수역':         1,  # 6
    '상왕십리역':     1,  # 2
    '상월곡역':       1,  # 6
    '새절역':         1,  # 6
    '서강대역':       1,  # 경의중앙
    '서대문역':       1,  # 5
    '서빙고역':       1,  # 경의중앙
    '서울대입구역':   1,  # 2
    '서울숲역':       1,  # 수인분당
    '서울역':         4,  # 1, 4, 경의중앙, 공항철도
    '서초역':         1,  # 2
    '석계역':         2,  # 1, 6
    '석촌고분역':     1,  # 9
    '석촌역':         2,  # 8, 9
    '선릉역':         2,  # 2, 수인분당
    '선유도역':       1,  # 9
    '선정릉역':       1,  # 9
    '성수역':         1,  # 2
    '성신여대입구역': 2,  # 4, 우이신설
    '솔밭공원역':     1,  # 우이신설
    '송정역':         1,  # 경의중앙
    '송파나루역':     1,  # 9
    '송파역':         1,  # 8
    '수락산역':       1,  # 7
    '수색역':         1,  # 경의중앙
    '수서역':         2,  # 3, 수인분당
    '수유역':         1,  # 4
    '숙대입구역':     1,  # 4
    '숭실대입구역':   1,  # 7
    '신금호역':       1,  # 5
    '신길역':         1,  # 5
    '신내역':         1,  # 경의중앙
    '신논현역':       1,  # 9
    '신당역':         2,  # 2, 6
    '신대방삼거리역': 1,  # 7
    '신대방역':       1,  # 2
    '신도림역':       2,  # 1, 2
    '신림역':         1,  # 2
    '신목동역':       1,  # 9
    '신방화역':       1,  # 9
    '신사역':         2,  # 3, 신분당
    '신설동역':       3,  # 1, 2, 우이신설
    '신정네거리역':   1,  # 2
    '신정역':         1,  # 5
    '신촌역':         1,  # 2 (경의중앙 신촌역과 별개)
    '신풍역':         1,  # 7
    '아차산역':       1,  # 5
    '아현역':         1,  # 2
    '안암역':         1,  # 6
    '암사역':         1,  # 8
    '압구정역':       1,  # 3
    '애오개역':       1,  # 5
    '약수역':         2,  # 3, 6
    '양재역':         2,  # 3, 신분당
    '양천향교역':     1,  # 9
    '양평역':         1,  # 5
    '어린이대공원역': 1,  # 7
    '언주역':         1,  # 9
    '역삼역':         1,  # 2
    '역촌역':         1,  # 6
    '연신내역':       2,  # 3, 6
    '염창역':         1,  # 9
    '영등포구청역':   2,  # 2, 5
    '영등포시장역':   1,  # 5
    '영등포역':       1,  # 1
    '오금역':         2,  # 3, 5
    '오류동역':       1,  # 1
    '오목교역':       1,  # 5
    '옥수역':         2,  # 3, 경의중앙
    '온수역':         2,  # 1, 7
    '왕십리역':       4,  # 2, 5, 경의중앙, 수인분당
    '외대앞역':       1,  # 1
    '우장산역':       1,  # 5
    '월계역':         1,  # 1
    '월곡역':         1,  # 6
    '을지로3가역':    2,  # 2, 3
    '을지로4가역':    2,  # 2, 5
    '을지로입구역':   1,  # 2
    '응암역':         1,  # 6
    '이대역':         1,  # 2
    '이수역':         2,  # 4, 7 (총신대입구=이수)
    '잠실나루역':     1,  # 2
    '잠실역':         2,  # 2, 8
    '잠원역':         1,  # 3
    '장승배기역':     1,  # 7
    '정릉역':         1,  # 우이신설
    '제기동역':       1,  # 1
    '종각역':         1,  # 1
    '종로3가역':      3,  # 1, 3, 5
    '종로5가역':      1,  # 1
    '중곡역':         1,  # 7
    '중랑역':         1,  # 경의중앙
    '중화역':         1,  # 7
    '증산역':         1,  # 6
    '창동역':         2,  # 1, 4
    '창신역':         1,  # 6
    '천호역':         2,  # 5, 8
    '청구역':         2,  # 5, 6
    '청담역':         1,  # 7
    '충무로역':       2,  # 3, 4
    '충정로역':       2,  # 2, 5
    '태릉입구역':     2,  # 6, 7
    '학동역':         1,  # 7
    '한강진역':       1,  # 6
    '한성대입구역':   1,  # 4
    '한성백제역':     1,  # 9
    '한양대역':       1,  # 2
    '한티역':         1,  # 수인분당
    '합정역':         2,  # 2, 6
    '행당역':         2,  # 5, 6
    '혜화역':         1,  # 4
    '홍대입구역':     3,  # 2, 경의중앙, 공항철도
    '홍제역':         1,  # 3
    '화계역':         1,  # 우이신설
    '화곡역':         1,  # 5
    '화랑대역':       1,  # 6
    '회기역':         2,  # 1, 경의중앙
    '회현역':         1,  # 4
    '효창공원앞역':   2,  # 6, 경의중앙
}

# ── 역 데이터 로드 및 노선_수 할당 ──────────────────────────────────────────
stations = pd.read_csv('station_coords.csv', encoding='utf-8-sig')
stations['노선_수'] = stations['역명'].map(STATION_LINES)

# 매핑 안 된 역 확인
unmatched = stations[stations['노선_수'].isna()]['역명'].tolist()
if unmatched:
    print(f"⚠️  매핑 안 된 역 ({len(unmatched)}개): {unmatched}")
    stations['노선_수'] = stations['노선_수'].fillna(1)  # 기본값 1

stations['노선_수'] = stations['노선_수'].astype(int)
print(f"역 데이터: {len(stations)}개, 노선_수 합계: {stations['노선_수'].sum()}")

# ── WGS84 → TM(EPSG:5181) 좌표 변환 ─────────────────────────────────────────
transformer = pyproj.Transformer.from_crs("EPSG:4326", "EPSG:5181", always_xy=True)
stations['tm_x'], stations['tm_y'] = transformer.transform(
    stations['역_lon'].values, stations['역_lat'].values
)

# ── 상권 좌표 로드 ────────────────────────────────────────────────────────────
to_map = pd.read_csv('to_map.csv', encoding='utf-8-sig')
sanggwon = to_map[['상권_코드', '엑스좌표_값', '와이좌표_값']].drop_duplicates('상권_코드')

# ── KDTree: 각 상권에서 반경 500m 내 역들의 노선_수 합산 ────────────────────
station_coords = stations[['tm_x', 'tm_y']].values
tree = cKDTree(station_coords)

results = []
for _, row in sanggwon.iterrows():
    indices = tree.query_ball_point([row['엑스좌표_값'], row['와이좌표_값']], r=500)
    노선수합 = int(stations.iloc[indices]['노선_수'].sum()) if indices else 0
    results.append({'상권_코드': int(row['상권_코드']), '지하철_노선_수': 노선수합})

noson_df = pd.DataFrame(results)
print(f"\n상권별 지하철_노선_수 분포:")
print(noson_df['지하철_노선_수'].value_counts().sort_index())

# ── 최종 데이터셋에 병합 ─────────────────────────────────────────────────────
main = pd.read_csv('y_demand_supply_trend_merge.csv', encoding='utf-8-sig')
main = main.merge(noson_df, on='상권_코드', how='left')
main['지하철_노선_수'] = main['지하철_노선_수'].fillna(0).astype(int)

# 저장
main.to_csv('y_demand_supply_trend_merge.csv', index=False, encoding='utf-8-sig')
print(f"\n✅ 완료: {main.shape}")
print(f"기존 지하철_역_수: {main['지하철_역_수'].sum():.0f}")
print(f"신규 지하철_노선_수: {main['지하철_노선_수'].sum():.0f}")
