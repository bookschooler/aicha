# 찻집 상권분석 프로젝트
## XGBoost + SHAP 변수 중요도 분석 보고서

> 스크립트: `31_feature_selection_xgb_shap.py`
> 분석 기준: 9,751행 × 22개 변수 | 명동 관광특구 제외 | Y변수: log(당월_매출_금액+1)

---

## 1. 분석 개요

| 항목 | 내용 |
|---|---|
| 최종 목표 | 수요 높고 공급(찻집) 적은 블루오션 상권 발굴 |
| 본 단계 목표 | Feature Selection — 22개 변수 중 회귀에 포함할 핵심 변수 선별 |
| 분석 방법 | XGBoost 학습 → 변수 중요도 → SHAP 기여도 분석 |
| 데이터 | y_demand_supply_trend_merge.csv (9,751행 × 22개 변수, 명동 제외) |
| Y변수 | log(당월_매출_금액 + 1) — 왜도 보정을 위한 로그변환 |

---

## 2. 모델 성능 (5-Fold 교차검증)

### 교차검증이란?
전체 데이터를 5등분하여 4/5로 학습, 1/5로 검증을 5회 반복합니다.
특정 데이터에 과적합되지 않고 일반적인 예측력을 측정할 수 있습니다.

| 구분 | R² |
|---|---|
| Fold 1 | 0.9025 |
| Fold 2 | 0.9127 |
| Fold 3 | 0.8990 |
| Fold 4 | 0.8988 |
| Fold 5 | 0.9107 |
| **평균 (CV R²)** | **0.9047 ★** |
| 전체 데이터 R² | 0.9536 (학습 데이터 기준, 과적합 포함) |

**해석:**
- CV R² = 0.9047 → 22개 변수만으로 매출 분산의 **90.5% 설명** 가능
- Fold 간 편차(±0.006)가 매우 작아 모델이 안정적
- 전체 R²(0.9536)가 CV R²보다 높은 것은 정상적인 현상이며, CV 수치가 실제 예측력에 더 가까움

---

## 3. XGBoost 변수 중요도

### 측정 방식
`feature_importances_`: 각 변수가 트리 분기 기준으로 얼마나 자주, 효과적으로 사용되었는지를 측정합니다. (사용 빈도 기반)

| 순위 | 변수명 | 중요도 | 그룹 | 해석 |
|---|---|---|---|---|
| 1 | 카페음료_점포수 | 0.2340 | 공급지표 | 압도적 1위. 카페 밀집도가 매출과 가장 강하게 연관 |
| 2 | 집객시설_수 | 0.1092 | 수요-인프라 | EDA보다 크게 높아진 순위. 비선형 효과 포착 |
| 3 | 총_직장_인구_수 | 0.0809 | 수요-인구 | 안정적 고정 수요 지표 |
| 4 | 공급갭_지수 | 0.0764 | 조합지표 | 블루오션 핵심 지표 |
| 5 | 지하철_역_수 | 0.0747 | 접근성 | SHAP에서는 15위 → 자주 쓰이나 실제 기여는 작음 |
| 6 | 찻집_수 | 0.0501 | 공급지표 | SHAP에서는 21위 → 해석 주의 필요 |
| 7 | 월_평균_소득_금액 | 0.0449 | 수요-소비 | SHAP에서 4위로 상승 → 비선형 효과 존재 |
| 8 | 지하철_노선_수 | 0.0356 | 접근성 | 환승 가중치 반영 지표 |
| 9 | 여가소비_지수 | 0.0334 | 조합지표 | 찻집 1개당 여가지출 |
| 10 | 지출_총금액 | 0.0322 | 수요-소비 | 전체 소비력 지표 |
| 11 | 상주밀도_지수 | 0.0302 | 조합지표 | |
| 12 | 아파트_평균_시가 | 0.0294 | 수요-소비 | |
| 13 | 여가_지출_총금액 | 0.0277 | 수요-소비 | |
| 14 | 스타벅스_리저브_수 | 0.0247 | 공급지표 | |
| 15 | 카페_검색지수 | 0.0242 | 트렌드 | SHAP에서 9위로 상승 → 비선형 효과 |
| 16 | 총_가구_수 | 0.0222 | 수요-인구 | |
| 17 | 총_상주인구_수 | 0.0215 | 수요-인구 | |
| 18 | 유동밀도_지수 | 0.0160 | 조합지표 | 제거 후보 |
| 19 | 총_유동인구_수 | 0.0132 | 수요-인구 | 의외로 낮은 순위 |
| 20 | 카페_개업률 | 0.0099 | 트렌드 | 제거 후보 |
| 21 | 유동인구_성장률 | 0.0053 | 트렌드 | 제거 후보 |
| 22 | 검색량_성장률 | 0.0044 | 트렌드 | 제거 후보 |

---

## 4. SHAP 분석

### SHAP이란?
SHAP(SHapley Additive exPlanations)은 각 변수가 개별 예측값을 기준값(전체 평균)에서 얼마나 이동시켰는지를 계산합니다. XGBoost의 "블랙박스"를 투명하게 해석하는 도구입니다.

**예시:**
```
상권A 예측 매출 = 기준값 5억
  + 카페음료_점포수 많음  → +2억
  + 총_직장_인구_수 많음  → +1.5억
  - 찻집_수 많음          → -0.5억
  = 예측 8억
```

### SHAP 평균 절대값 순위
평균 |SHAP|: 전체 상권에 걸쳐 해당 변수가 매출 예측값을 평균적으로 얼마나 움직였는지를 나타냅니다.

| 순위 | 변수명 | 평균\|SHAP\| | 그룹 | 해석 |
|---|---|---|---|---|
| 1 | 카페음료_점포수 | 0.424 | 공급지표 | 두 방법 모두 1위. 확실한 핵심 변수 |
| 2 | 집객시설_수 | 0.401 | 수요-인프라 | 두 방법 모두 2위. 확실한 핵심 변수 |
| 3 | 총_직장_인구_수 | 0.265 | 수요-인구 | 직장인구의 안정적 설명력 재확인 |
| 4 | 월_평균_소득_금액 | 0.260 | 수요-소비 | ★ XGBoost 7위 → SHAP 4위. 비선형 효과 발견 |
| 5 | 지출_총금액 | 0.160 | 수요-소비 | 전체 소비력 |
| 6 | 아파트_평균_시가 | 0.144 | 수요-소비 | 지역 자산 수준 |
| 7 | 총_가구_수 | 0.136 | 수요-인구 | 가구 밀집도 |
| 8 | 상주밀도_지수 | 0.125 | 조합지표 | 찻집 1개당 여성 상주인구 |
| 9 | 카페_검색지수 | 0.104 | 트렌드 | ★ EDA R²=0.002 → SHAP 9위. 비선형 효과 |
| 10 | 총_상주인구_수 | 0.079 | 수요-인구 | 상주 수요 |
| 11 | 여가_지출_총금액 | 0.078 | 수요-소비 | |
| 12 | 공급갭_지수 | 0.076 | 조합지표 | 블루오션 핵심 지표 |
| 13 | 여가소비_지수 | 0.062 | 조합지표 | |
| 14 | 총_유동인구_수 | 0.055 | 수요-인구 | 직장인구 대비 낮은 설명력 |
| 15 | 지하철_역_수 | 0.038 | 접근성 | XGBoost 5위 → SHAP 15위 (과대평가됐었음) |
| 16 | 카페_개업률 | 0.031 | 트렌드 | |
| 17 | 지하철_노선_수 | 0.031 | 접근성 | |
| 18 | 유동밀도_지수 | 0.030 | 조합지표 | **제거 후보** |
| 19 | 유동인구_성장률 | 0.021 | 트렌드 | **제거 후보** |
| 20 | 검색량_성장률 | 0.013 | 트렌드 | **제거 후보** |
| 21 | 찻집_수 | 0.011 | 공급지표 | 통계적 중요도 낮음. 블루오션 개념상 유지 논의 필요 |
| 22 | 스타벅스_리저브_수 | 0.001 | 공급지표 | **★ 제거 권고. 사실상 무의미** |

---

## 5. XGBoost vs SHAP 순위 비교

### 두 방법의 차이

| 방법 | 측정 기준 | 특징 |
|---|---|---|
| XGBoost feature_importances_ | 트리 분기 횟수 + 효과 기반 | 사용 빈도 반영 → 자주 쓰이나 영향 작은 변수 과대평가 가능 |
| SHAP 평균 절대값 | 개별 예측 기여도 기반 | 실제 매출 변화 기여도 반영 → 더 신뢰성 높음 |

### 주목할 불일치 변수

| 변수 | XGBoost 순위 | SHAP 순위 | 해석 |
|---|---|---|---|
| 지하철_역_수 | 5위 | 15위 | XGBoost 과대평가. 트리 분기에 자주 쓰이나 실제 매출 기여는 작음 |
| 찻집_수 | 6위 | 21위 | 분기 기준으로는 유용하나 실제 매출 설명력은 낮음 |
| 월_평균_소득_금액 | 7위 | 4위 | SHAP에서 크게 상승. 소득 임계점에서 비선형 효과 존재 |
| 카페_검색지수 | 15위 | 9위 | EDA R²=0.002였으나 비선형 효과로 실제 기여도 존재 |

---

## 6. SHAP Summary Plot 해석

- **X축(SHAP value)**: 양수 → 매출 높이는 방향, 음수 → 매출 낮추는 방향
- **점 색(빨강)**: 해당 변수값이 높음 / **점 색(파랑)**: 해당 변수값이 낮음

| 변수 | SHAP 플롯 패턴 | 해석 |
|---|---|---|
| 카페음료_점포수 | 빨간 점(카페 많음)이 오른쪽 집중 | 카페 많을수록 매출 높음. SHAP 최대 +2.0으로 가장 큰 영향 |
| 집객시설_수 | 점들이 넓게 분산, 비선형 패턴 | 100개 이하에서 음수 기여 → 100개 이상에서 급등. **임계점 존재** |
| 총_직장_인구_수 | 선형에 가까운 우상향 | 직장인구 많을수록 안정적으로 매출 높음 |
| 월_평균_소득_금액 | 소득 구간별 기여도 전환 | 저소득 구간에서 음수, 고소득 구간에서 양수로 전환. **임계점 존재** |
| 공급갭_지수 | 양쪽에 분산 | 공급갭이 높아도 수요 없는 곳은 효과 없음. 비선형 복합 관계 |
| 카페_검색지수 | 넓은 분산, 방향 혼재 | 상권 유형에 따라 효과 방향이 다름 (신흥 vs 확립 상권) |

---

## 7. 핵심 시사점

| 항목 | 내용 |
|---|---|
| 모델 설명력 | CV R²=0.905로 22개 변수의 설명력 매우 우수 |
| 확실한 핵심 변수 | 카페음료_점포수, 집객시설_수 — 두 방법 모두 1,2위 일치 |
| 새로 발견된 변수 | 월_평균_소득_금액 — EDA에서 주목 못했으나 SHAP 4위. 소득 임계점 효과 존재 |
| 제거 권고 변수 | 스타벅스_리저브_수(0.001), 검색량_성장률(0.013), 유동인구_성장률(0.021), 유동밀도_지수(0.030) |
| 논의 필요 변수 | 찻집_수 — 통계적 중요도 낮지만 블루오션 분석 목적상 포함 여부 검토 |
| 유동인구 vs 직장인구 | 총_유동인구_수(SHAP 14위, 0.055) << 총_직장_인구_수(3위, 0.265). **직장인구가 훨씬 중요** |

---

## 8. 다음 단계

| 스크립트 | 분석 | 내용 | 예상 결과물 |
|---|---|---|---|
| 32번 | Lasso/ElasticNet | 선형 모델 기반 변수 자동 제거 → 최종 변수 목록 확정 | fs_lasso_coef.csv, fs_lasso_path.png |
| 33번 | 전처리 확정 | 결측치 처리, 이상치 기준 확정, 표준화 | df_final_preprocessed.csv |
| 34번 | OLS 다중회귀 | 계수 해석 — 각 변수의 매출 영향력 수치화 | reg_ols_summary.txt, reg_ols_coef.csv |
| 35~36번 | 패널회귀 | 분기별 반복 구조 처리 (Fixed/Random Effect) | reg_panel_result.csv |
| 37번 | 블루오션 추천 | 예측매출 vs 실제매출 비교 → 저평가 상권 발굴 | blueocean_final_ranking.csv, blueocean_map.png |
